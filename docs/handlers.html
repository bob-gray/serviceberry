<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Handlers · Serviceberry</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;Understanding handlers is central to creating a service using Serviceberry. All things that&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Handlers · Serviceberry"/><meta property="og:type" content="website"/><meta property="og:url" content="https://serviceberry.js.org/index.html"/><meta property="og:description" content="&lt;p&gt;Understanding handlers is central to creating a service using Serviceberry. All things that&lt;/p&gt;
"/><meta property="og:image" content="https://serviceberry.js.org/img/serviceberry.svg"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/agate.min.css"/><link rel="alternate" type="application/atom+xml" href="https://serviceberry.js.org/blog/atom.xml" title="Serviceberry Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://serviceberry.js.org/blog/feed.xml" title="Serviceberry Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-116036661-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/serviceberry-horizontal.svg" alt="Serviceberry"/><h2 class="headerTitleWithLogo">Serviceberry</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/getting-started.html" target="_self">Guides</a></li><li class="siteNavGroupActive"><a href="/docs/serviceberry.html" target="_self">API Reference</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Guides</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Guides</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/getting-started.html">Getting Started</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/handlers.html">Handlers</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins.html">Plugins</a></li><li class="navListItem"><a class="navItem" href="/docs/service-tree.html">Service Tree</a></li><li class="navListItem"><a class="navItem" href="/docs/auto-responses.html">Auto Responses</a></li><li class="navListItem"><a class="navItem" href="/docs/how-it-works.html">How It Works</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">API Reference</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/serviceberry.html">Serviceberry</a></li><li class="navListItem"><a class="navItem" href="/docs/trunk.html">Trunk</a></li><li class="navListItem"><a class="navItem" href="/docs/branch.html">Branch</a></li><li class="navListItem"><a class="navItem" href="/docs/leaf.html">Leaf</a></li><li class="navListItem"><a class="navItem" href="/docs/request.html">Request</a></li><li class="navListItem"><a class="navItem" href="/docs/response.html">Response</a></li><li class="navListItem"><a class="navItem" href="/docs/httperror.html">HttpError</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Handlers</h1></header><article><div><span><p>Understanding handlers is central to creating a service using Serviceberry. All things that
interact with service requests do so through a common handler API. This means your endpoints,
plugins, error handlers, serializers and deserializers are all created in the same way.
This makes creating services and plugins easier.</p>
<p>A handler can be a <a href="#handler-functions">function</a> or an <a href="#handler-objects">object</a>
or a <a href="#handler-promise">promise</a> that resolves to a handler <a href="#handler-functions">function</a> or <a href="#handler-objects">object</a>.
Handler objects can be any object with a <code>use</code> method that is a handler function.</p>
<h2><a class="anchor" aria-hidden="true" id="handler-functions"></a><a href="#handler-functions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Handler Functions</h2>
<p>Handler functions all have the same arguments signature <code>(request, response)</code> and ability to control requests.
<a href="request.html">Request</a> and <a href="response.html">response</a> are wrapper objects for the
<a href="https://nodejs.org/dist/latest-v8.x/docs/api/http.html#http_class_http_incomingmessage">http.IncomingRequest</a>
and <a href="https://nodejs.org/dist/latest-v8.x/docs/api/http.html#http_class_http_serverresponse">http.ServiceResponse</a>
arguments passed to the underlining <a href="https://nodejs.org/dist/latest-v8.x/docs/api/http.html#http_class_http_server">http.Server</a>
<code>request</code> event listener.</p>
<ul>
<li><a href="request.html">request</a> <em>object</em></li>
<li><a href="response.html">response</a> <em>object</em></li>
</ul>
<p>Handlers are added to the <a href="trunk.html">trunk</a>, <a href="branch.html">branches</a> and <a href="leaf.html">leaves</a>
of your service using methods <code>use</code>, <code>catch</code> and <code>on</code>. When Serviceberry routes each request through your service, it builds a queue of handlers. Each handler in the queue is then called one after the other. Each given control of the
<a href="request.html">request</a> and <a href="response.html">response</a> until control is exercised and transferred away. Handlers exercise control through
methods of <a href="request.html">request</a> and <a href="response.html">response</a>, their return value or by throwing an error.</p>
<h3><a class="anchor" aria-hidden="true" id="three-possible-outcomes"></a><a href="#three-possible-outcomes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Three Possible Outcomes</h3>
<p>Each handler has exactly one opportunity to exercise control. Once action has been taken, control
is transferred away from the handler. There are three possible outcomes.</p>
<ol>
<li>Proceed with the request (typical for a plugin).</li>
<li>Complete the request and send a response to the client (typical for an endpoint).</li>
<li>Fallback to the nearest catch.</li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="controlling-the-outcome"></a><a href="#controlling-the-outcome" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Controlling the Outcome</h3>
<p>Which outcome occurs depends primarily on the value returned from the handler. The handler can exercise
control over the <a href="request.html">request</a> and <a href="response.html">response</a> by the following actions.</p>
<ol>
<li>Return a <a href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise"><code>promise</code></a>
(any thennable should work).</li>
<li>Return something other than <code>false</code> that is not thennable.</li>
<li>Return nothing and call <a href="request.html#proceed-value"><code>request.proceed()</code></a>.</li>
<li>Return nothing and call <a href="response.html#send-options"><code>response.send()</code></a>.</li>
<li>Return nothing and call <a href="request.html#failerror-status-headers"><code>request.fail()</code></a>.</li>
<li>Return <code>false</code>.</li>
<li>Throw an error.</li>
</ol>
<p>Returning a <code>promise</code> that is resolved or eventually resolved, returning anything other than <code>false</code> or a
thennable, or returning nothing and calling <a href="request.html#proceed-value"><code>request.proceed()</code></a> are all functionally equivalent. They all result in the request
proceeding. Control will be given to the next handler in the queue. If the queue has no more handlers,
the request will end and a response sent to the client.</p>
<p>Returning nothing and calling <a href="response.html#send-options"><code>response.send()</code></a> will complete the request and send the response to the client.</p>
<p>Returning a <code>promise</code> that is rejected or eventually rejected, returning <code>false</code>, throwing an error, or returning
nothing and calling <a href="request.html#failerror-status-headers"><code>request.fail()</code></a> are all functionally equivalent. They all result in control falling back to the nearest error handler. If no error handler is found the request will be ended. Errors are available in error handlers
at <a href="request.html#error"><code>request.error</code></a>.</p>
<p><a href="request.html#proceed-value"><code>request.proceed()</code></a>, <a href="request.html#failerror-status-headers"><code>request.fail()</code></a> and <a href="response.html#send-options"><code>response.send()</code></a> can all be called asynchronously as long
as the handler doesn't return a value. Additionally none are required to be called with context so
each can be safely passed directly as callbacks - such as <code>.then(request.proceed, request.fail)</code>. When control is exercised and transferred away, request and response methods given to the prior handler are rendered useless.</p>
<h2><a class="anchor" aria-hidden="true" id="handler-objects"></a><a href="#handler-objects" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Handler Objects</h2>
<p>Everywhere a handler is accepted as an argument, an object can be used. It can be any object that has a <code>use</code>
method that is a handler function. When Serviceberry is passed a handler object it binds the object's <code>use</code> method to the object so that handlers can be stateful. This can be particularly useful for plugins.</p>
<h2><a class="anchor" aria-hidden="true" id="handler-promises"></a><a href="#handler-promises" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Handler Promises</h2>
<p>Everywhere a handler is accepted as a argument, a promise can be used. The promise
must resolve to a handler <a href="#handler-function">function</a> or handler <a href="#handler-promises">object</a>.
The service <a href="trunk.html">trunk</a> will wait until all handlers are resolved before
starting.</p>
<p>To learn about using and creating <a href="plugins.html">plugins</a>, checkout the next guide.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/getting-started.html"><span class="arrow-prev">← </span><span>Getting Started</span></a><a class="docs-next button" href="/docs/plugins.html"><span>Plugins</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#handler-functions">Handler Functions</a><ul class="toc-headings"><li><a href="#three-possible-outcomes">Three Possible Outcomes</a></li><li><a href="#controlling-the-outcome">Controlling the Outcome</a></li></ul></li><li><a href="#handler-objects">Handler Objects</a></li><li><a href="#handler-promises">Handler Promises</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>Guides</h5><a href="/docs/getting-started.html">Getting Started</a><a href="/docs/handlers.html">Handlers</a><a href="/docs/plugins.html">Plugins</a><a href="/docs/service-tree.html">Serice Tree</a><a href="/docs/auto-responses.html">Auto Responses</a><a href="/docs/how-it-works.html">How it Works</a></div><div><h5>API Reference</h5><a href="/docs/serviceberry.html">Serviceberry</a><a href="/docs/trunk.html">Trunk</a><a href="/docs/branch.html">Branch</a><a href="/docs/leaf.html">Leaf</a><a href="/docs/request.html">Reqeust</a><a href="/docs/response.html">Response</a><a href="/docs/httperror.html">HttpError</a></div><div><h5>More</h5><a href="/blog">Blog</a><a class="github-link" href="https://github.com/bob-gray/serviceberry">GitHub</a><a class="github-button" href="https://github.com/bob-gray/serviceberry" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><a href="/docs/contributing.html">Contributing</a><a href="/docs/license.html">License</a></div></section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'd8f71d3fca61a88437ddb93081120da2',
                indexName: 'serviceberry',
                inputSelector: '#search_input_react'
              });
            </script></body></html>